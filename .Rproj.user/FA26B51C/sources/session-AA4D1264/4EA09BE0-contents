library( tidyverse )
library( VGAM )
# read in raw data file
d <- read.csv( "01-Data-Raw/ca_hei.csv")

# helper function
source( "R/utils.R")

# compute quartiles only on cancer survivors and generate normalized weights (note: first adjust weights based on number of cycles in the analysis)
d.2 <- d %>%
  filter( CA == 1 ) %>%   # filter cancer survivors
  mutate( hei.q4 = as.factor( quant_cut( "HEI2015_TOTAL_SCORE", 4, . ) ),
          fafh.q4 = as.factor( quant_cut( "FAFH", 4, . ) ),
          norm.wt = ( WTINT2YR /5 ) / mean( d$WTINT2YR, na.rm = T ) ) %>% # rank variables for HEI and FAFH
  full_join( d, . )  # full join back to original data to keep all rows intact for analysis



mod3 <- vglm( factor( hei.q4, ordered = T ) ~ fafh.q4 + Gender2 +
                Age + Race2 +HHSize2 + HHIncome_cat + EDU + MartitalStat_cat +
                ,
              family = propodds( reverse = FALSE ), data = d.2, weights = norm.wt  )
summary( mod3 )
